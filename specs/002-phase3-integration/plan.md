# Implementation Plan: Phase 3 통합 - DateFilter 마이그레이션 & 유틸리티 리팩토링

**Branch**: `002-phase3-integration` | **Date**: 2025-11-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-phase3-integration/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

**Primary Requirement**: DateFilterContext를 Zustand Store로 마이그레이션하고, 프로젝트 전반에 걸친 날짜 처리 및 Firebase 에러 처리 중복 코드를 중앙화된 유틸리티 함수로 리팩토링합니다.

**Technical Approach** (5 clarifications resolved):
1. **DateFilter 마이그레이션**: Context API → Zustand Store with localStorage persist (새로운 키 사용)
2. **날짜 유틸리티**: 20개 파일에서 중복 패턴 완전 제거 (29회 → 0회), 포맷 옵션 지원
3. **Firebase 에러 유틸리티**: 표준화된 에러 처리 및 사용자 친화적 메시지 변환
4. **FormUtils**: 폼 상태 관리 중복 제거 (제네릭 핸들러)
5. **에러 처리 전략**: null 반환 + logger 경고 (프로덕션 안정성)

**Scope**: 7일 작업 (56시간) - Part 1 (DateFilter 2일) + Part 2 (유틸리티 4일) + 통합 테스트 (1일)

## Technical Context

**Language/Version**: TypeScript 4.9 (Strict Mode)
**Primary Dependencies**:
- Zustand 5.0 (persist middleware)
- React 18.2
- date-fns 4.1 (참고용, 필수 아님)
- Firebase 11.9 (Firestore)

**Storage**:
- Zustand Store (in-memory state)
- localStorage (날짜 persistence)
- Firestore (토너먼트 데이터)

**Testing**: Jest + React Testing Library (단위 테스트 커버리지 80%+)

**Target Platform**: Web (React SPA) + Capacitor 7.4 (모바일 앱)

**Project Type**: Web Application (app2/ 디렉토리)

**Performance Goals**:
- Context 제거로 리렌더링 최소화
- localStorage 읽기/쓰기 비동기 처리
- 유틸리티 함수 메모이제이션 가능

**Constraints**:
- TypeScript strict mode 100% 준수 (any 타입 금지)
- 기존 API 100% 호환성 유지 (Breaking changes 없음)
- 프로덕션 안정성 (에러 발생 시 앱 크래시 방지)
- 다크모드 필수 적용 (`dark:` 클래스)

**Scale/Scope**:
- DateFilter: 6개 파일 마이그레이션
- 날짜 유틸리티: 20개 파일, 29회 사용 패턴 제거
- Firebase 에러: 20개 파일 표준화
- 테스트: 최소 15개 테스트 케이스

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Constitution Status**: Constitution file is empty (template only). Proceeding with standard best practices:

**Project Principles (Inferred from CLAUDE.md)**:
- ✅ **TypeScript Strict Mode**: 100% 준수 (any 타입 금지)
- ✅ **Logger 사용**: console.log 금지, logger 필수
- ✅ **표준 필드명**: staffId, eventId 일관성 유지
- ✅ **실시간 구독**: Firebase onSnapshot 사용
- ✅ **다크모드**: 모든 UI 요소에 dark: 클래스 적용
- ✅ **메모이제이션**: useMemo, useCallback 활용

**Feature-Specific Gates**:
1. ✅ **API 호환성**: 기존 DateFilterContext API 100% 유지
2. ✅ **단계적 마이그레이션**: 점진적 변경 (Phase 3-1 패턴 참고)
3. ✅ **테스트 커버리지**: 80% 이상 (단위 + 통합)
4. ✅ **에러 처리**: null 반환 + logger (앱 크래시 방지)
5. ✅ **Performance**: 회귀 없음 (기존 기능 유지)

**Gates Status**: All gates passed. No constitution violations.

## Project Structure

### Documentation (this feature)

```text
specs/002-phase3-integration/
├── spec.md              # Feature specification (완료)
├── checklists/
│   └── requirements.md  # Quality checklist (완료)
├── plan.md              # This file (/speckit.plan output)
├── research.md          # Phase 0 output (진행 중)
├── data-model.md        # Phase 1 output (대기 중)
├── quickstart.md        # Phase 1 output (대기 중)
├── contracts/           # Phase 1 output (대기 중)
└── tasks.md             # Phase 2 output (/speckit.tasks - NOT created yet)
```

### Source Code (repository root)

**Structure Decision**: Web Application (app2/ 디렉토리) - React SPA with TypeScript

```text
app2/
├── src/
│   ├── stores/                   # NEW: Zustand stores
│   │   ├── dateFilterStore.ts    # DateFilter state management
│   │   └── unifiedDataStore.ts   # Existing (Phase 3-1 완료)
│   │
│   ├── hooks/                    # React hooks
│   │   ├── useDateFilter.ts      # NEW: Compatibility layer
│   │   └── useUnifiedData.ts     # Existing
│   │
│   ├── utils/                    # NEW: Utility modules
│   │   ├── dateUtils.ts          # 날짜 처리 유틸리티
│   │   ├── firebaseErrors.ts     # Firebase 에러 처리
│   │   ├── formUtils.ts          # 폼 핸들러 유틸리티
│   │   └── logger.ts             # Existing logger
│   │
│   ├── contexts/                 # Context API (제거 예정)
│   │   ├── DateFilterContext.tsx # REMOVE: 마이그레이션 후 삭제
│   │   └── TournamentDataContext.tsx  # Keep (not migrating)
│   │
│   ├── pages/                    # 마이그레이션 대상 페이지
│   │   ├── TablesPage/           # DateFilter 사용 (1/6)
│   │   ├── ParticipantsPage/     # DateFilter 사용 (2/6)
│   │   ├── MySchedulePage/       # 날짜 유틸리티 사용
│   │   └── JobPostingPage/       # Firebase 에러 처리
│   │
│   └── components/               # 공용 컴포넌트
│       └── DateNavigator/        # DateFilter 사용 (3/6)
│
└── tests/
    ├── unit/
    │   ├── stores/
    │   │   └── dateFilterStore.test.ts  # NEW
    │   └── utils/
    │       ├── dateUtils.test.ts         # NEW
    │       ├── firebaseErrors.test.ts    # NEW
    │       └── formUtils.test.ts         # NEW
    │
    └── integration/
        └── dateFilterMigration.test.ts   # NEW
```

**Migration Target Files** (from spec.md):
- DateFilter 사용: 6개 파일
- 날짜 포맷팅 중복: 20개 파일, 29회 사용
- Firebase 에러 처리: 20개 파일

## Complexity Tracking

> Constitution Check에 위반 사항이 없으므로 이 섹션은 비어 있습니다.

**No violations detected**. 모든 설계 결정이 프로젝트 원칙과 일치합니다.

---

## Phase 0: Research & Unknowns Resolution

**Status**: In Progress

### Research Topics

#### 1. Zustand Persist Configuration
**Question**: localStorage 직렬화/역직렬화 전략 및 Zustand persist middleware 설정

**Current Understanding**:
- Phase 3-1에서 Zustand 5.0 + persist 사용 경험 있음
- 기존 `tournament_selected_date` 키는 단순 문자열 저장
- 새로운 Zustand store는 객체 구조로 저장

**Research Needed**:
- Zustand persist storage 옵션 (getItem, setItem, removeItem)
- 날짜 직렬화 시 Date 객체 → 문자열 변환 전략
- localStorage 실패 시 메모리 폴백 구현

**Decision** (from Clarification #2):
- 새로운 localStorage 키 사용 (`date-filter-storage`)
- 기존 `tournament_selected_date` 데이터 무시 (구현 단순성 우선)

#### 2. Date Formatting Library Choice
**Question**: date-fns 사용 여부 vs 네이티브 JavaScript Date API

**Current Understanding**:
- date-fns 4.1 설치되어 있음 (package.json 확인 필요)
- 기존 코드는 네이티브 API 사용 (`toISOString().split('T')[0]`)

**Research Needed**:
- date-fns format() 함수 성능 vs 네이티브 API
- 번들 크기 영향 (tree-shaking 가능 여부)
- 타임존 처리 안정성

**Preliminary Decision**:
- 네이티브 API 우선 (번들 크기 최소화)
- date-fns는 복잡한 날짜 계산에만 사용 (선택적)

#### 3. TypeScript Generic Patterns
**Question**: 유틸리티 함수에서 제네릭 타입 설계 방법

**Current Understanding**:
- `formatDate()`: 입력 타입 `Date | string`, 출력 `string | null`
- `createFormHandler<T>()`: 제네릭 state 타입 T
- TypeScript strict mode 활성화

**Research Needed**:
- 제네릭 타입 constraint 설계 (extends 절 사용)
- 타입 가드 함수 패턴 (`isValidDate`)
- null 반환 시 타입 안정성 (Clarification #1)

**Design Pattern**:
```typescript
// 날짜 유틸리티
export function formatDate(
  date: Date | string | null | undefined,
  format: 'date' | 'datetime'
): string | null;

// 폼 유틸리티
export function createFormHandler<T extends Record<string, any>>(
  setState: React.Dispatch<React.SetStateAction<T>>
): (field: keyof T) => (value: any) => void;
```

#### 4. Firebase Error Code Mapping
**Question**: Firebase 에러 코드 → 한국어/영어 메시지 매핑 전략

**Current Understanding**:
- Firebase 에러는 `code` 속성 가짐 (`permission-denied`, `not-found`, etc.)
- i18n 시스템 존재 가정 (Assumption #8)

**Research Needed**:
- 주요 Firebase 에러 코드 목록 (20개 파일 분석)
- i18n 키 구조 (`errors.firebase.permission-denied`)
- 기본 메시지 fallback 전략

**Example Mapping**:
```typescript
const FIREBASE_ERROR_MESSAGES: Record<string, {ko: string, en: string}> = {
  'permission-denied': {
    ko: '권한이 없습니다. 관리자에게 문의하세요.',
    en: 'Permission denied. Contact administrator.'
  },
  // ... 추가 매핑
};
```

#### 5. Phase 3-1 Pattern Analysis
**Question**: Phase 3-1 (UnifiedDataContext → Zustand) 성공 패턴 분석

**Current Understanding**:
- Phase 3-1 완료일: 2025-11-19
- 성과: Context API 완전 제거, 성능 32.3배 향상, API 100% 호환
- 파일 위치: `app2/src/stores/unifiedDataStore.ts`

**Research Needed**:
- unifiedDataStore 코드 리뷰 (패턴 파악)
- 호환성 레이어 (`useUnifiedData` Hook) 구조
- 테스트 전략 및 마이그레이션 순서

**Action**: Read `app2/src/stores/unifiedDataStore.ts` for pattern reference

---

## Phase 1: Data Model & Contracts

**Status**: ✅ Completed (2025-11-20)

**Output Files**:
- ✅ `data-model.md`: DateFilterStore, 유틸리티 함수 인터페이스 (완료)
- ✅ `contracts/`: API 시그니처 및 타입 정의 (4개 파일 완료)
  - `dateFilterStore.ts`: DateFilterStore contracts
  - `dateUtils.ts`: DateUtils contracts
  - `firebaseErrors.ts`: FirebaseErrorUtils contracts
  - `formUtils.ts`: FormUtils contracts
- ✅ `quickstart.md`: 개발자 온보딩 가이드 (완료)
- ✅ Agent Context 업데이트: CLAUDE.md (완료)

**Completed Steps**:
1. ✅ Research.md 생성 (모든 NEEDS CLARIFICATION 해결)
2. ✅ Data Model 설계 (DateFilterStore, DateUtils, FirebaseErrorUtils, FormUtils)
3. ✅ TypeScript 인터페이스 및 타입 정의 (contracts/ 생성)
4. ✅ Agent Context 업데이트 (CLAUDE.md)

---

## Planning Phase Complete

**Current Phase**: Planning Complete ✅
**Next Command**: `/speckit.tasks` (Phase 2: Task Generation)
**Estimated Completion**: Planning phase 완료, 구현 준비 완료
